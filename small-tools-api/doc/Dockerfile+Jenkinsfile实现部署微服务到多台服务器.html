<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jenkins(11) Dockerfile+Jenkinsfile实现部署微服务到多台服务器</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p></p><div class="toc"><h3>文章目录</h3><ul><ul><ul><li><a href="#_2">一、前言</a></li><li><a href="#jenkins_13">二、jenkins插件安装</a></li><li><a href="#jenkins_19">三、jenkins配置</a></li><ul><li><a href="#1_21">1、远程服务器配置</a></li><li><a href="#2_31">2、全局凭证配置</a></li><ul><ul><li><a href="#_git_37">① git全局凭证配置</a></li><li><a href="#_docker_40">② docker镜像仓库全局凭证配置</a></li></ul></ul></ul><li><a href="#_48">四、项目配置</a></li><ul><li><a href="#1Dockerfile_52">1、Dockerfile</a></li><li><a href="#2Jenkinsfile_107">2、Jenkinsfile</a></li></ul><li><a href="#jenkins_292">五、jenkins新建任务</a></li><li><a href="#_313">六、构建测试</a></li><li><a href="#_326">七、其它</a></li></ul></ul></ul></div><p></p>
<h3><a id="_2"></a>一、前言</h3>
<ol>
<li><a href="https://zhengqing.blog.csdn.net/article/details/118879799">Jenkins(7) 参数化构建配置</a></li>
<li><a href="https://zhengqing.blog.csdn.net/article/details/118882105">Jenkins(8) 远程服务器部署</a></li>
</ol>
<p>本文将通过<code>Dockerfile</code>+<code>Jenkinsfile</code>方案实现部署SpringCloud微服务项目到多台服务器</p>
<p>项目地址 <a href="https://gitee.com/zhengqingya/small-tools">https://gitee.com/zhengqingya/small-tools</a></p>
<blockquote>
<p>温馨小提示：本文示例项目基于码云仓库和阿里云镜像仓库环境</p>
</blockquote>
<h3><a id="jenkins_13"></a>二、jenkins插件安装</h3>
<ol>
<li>Publish Over SSH : 远程发布</li>
<li>Extended Choice Parameter ：参数化构建</li>
<li>Git Parameter ： Git参数化</li>
</ol>
<h3><a id="jenkins_19"></a>三、jenkins配置</h3>
<h4><a id="1_21"></a>1、远程服务器配置</h4>
<p><code>Manage Jenkins</code> -&gt; <code>Configure System</code><br>
<img src="https://img-blog.csdnimg.cn/ce33dd00e1c942d68009f9006b7f70a3.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
<code>Publish over SSH</code>配置</p>
<blockquote>
<p>温馨小提示：多台服务器则配置多个…</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/641243769ccb4df28620895cda3128e7.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h4><a id="2_31"></a>2、全局凭证配置</h4>
<blockquote>
<p>注：后面Jenkinsfile中需要使用到这里配置的全局凭证</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/102c840149ee452f9eeae05178fde429.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/941964e3ab9e4f62a5b918cae32f5cca.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h6><a id="_git_37"></a>① git全局凭证配置</h6>
<p><img src="https://img-blog.csdnimg.cn/732b3623d2b74851ae67989451028b68.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h6><a id="_docker_40"></a>② docker镜像仓库全局凭证配置</h6>
<p><img src="https://img-blog.csdnimg.cn/d82135c4435c4f2286e6b775f9a08d17.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>配置完后如下：<br>
<img src="https://img-blog.csdnimg.cn/b2b5024dd64547118db42cd71b903b0a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h3><a id="_48"></a>四、项目配置</h3>
<p><img src="https://img-blog.csdnimg.cn/71dbc5dadcee4e4ba8331526e12cb273.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h4><a id="1Dockerfile_52"></a>1、Dockerfile</h4>
<pre><code>#FROM openjdk:8-jre-alpine   【 注：jre中并没有携带工具文件，但arthas需要依赖lib包和bin包里面的包和工具，arthas需要jps工具和lib包里的内容 具体参考：https://www.cnblogs.com/sky-chen/p/9887777.html 】
#FROM openjdk:8-jdk-alpine
#RUN apk add --update ttf-dejavu fontconfig &amp;&amp; rm -rf /var/cache/apk/*
# 注：此镜像支持字体！
FROM registry.cn-hangzhou.aliyuncs.com/zhengqing/openjdk:8-jdk-alpine-font

# 维护者信息
MAINTAINER zhengqingya

# 构建镜像时传参数据
ARG APP_NAME
ARG APP_PORT
ARG JAVA_OPTS

# 设置环境变量-运行时也可传参进来耍哈
ENV APP_NAME ${APP_NAME}
ENV APP_JAR ${APP_NAME}.jar
ENV APP_PORT ${APP_PORT}
ENV JAVA_OPTS ${JAVA_OPTS}
# -XX:+UseG1GC -Xms64m -Xmx64m -Xmn16m -XX:MetaspaceSize=100m -XX:MaxMetaspaceSize=100m -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 -Ddefault.client.encoding=UTF-8 -Dfile.encoding=UTF-8 -Duser.language=Zh -Duser.region=CN -Dspring.profiles.active=xx -Dspring.cloud.nacos.discovery.server-addr=xx -Dspring.cloud.nacos.discovery.username=nacos  -Dspring.cloud.nacos.discovery.password=nacos
# 远程调试参数： -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5001

# 解决时差8小时问题
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone


# copy arthas
COPY --from=hengyunabc/arthas:latest /opt/arthas /opt/arthas

ADD ${APP_JAR} /home/
RUN sh -c 'touch /'

VOLUME /tmp

# 对外暴漏的端口号
# [注：EXPOSE指令只是声明容器运行时提供的服务端口，给读者看有哪些端口，在运行时只会开启程序自身的端口！！]
EXPOSE ${APP_PORT}

# 让你先休息3秒再开始运动吧🏃🏃🏃
CMD echo "****** Start... " &amp; \
    echo "****** APP_JAR: ${APP_JAR} " &amp; \
    echo "****** APP_PORT: ${APP_PORT} " &amp; \
    echo "****** JAVA_OPTS: ${JAVA_OPTS} " &amp; \
    echo "****** ${APP_JAR} will run ..." &amp; \
    sleep 3 &amp; \
    echo "****** 运行命令：nohup java -jar ${JAVA_OPTS} /home/${APP_JAR} &gt;&gt; /home/${APP_NAME}.log 2&gt;&amp;1 &amp;" &amp; \
    nohup java -jar ${JAVA_OPTS} /home/${APP_JAR} &gt;&gt; /home/${APP_NAME}.log 2&gt;&amp;1 &amp; \
    echo "****** 查看日志..." &amp; \
    tail -f /home/${APP_NAME}.log
</code></pre>
<h4><a id="2Jenkinsfile_107"></a>2、Jenkinsfile</h4>
<blockquote>
<p>流水线语法可参考：<a href="https://www.jenkins.io/zh/doc/book/pipeline/syntax">https://www.jenkins.io/zh/doc/book/pipeline/syntax</a></p>
</blockquote>
<pre><code>// ==================== ↓↓↓↓↓↓ docker ↓↓↓↓↓↓ ====================
// 镜像仓库地址
def DOCKER_REGISTRY_URL = "registry.cn-hangzhou.aliyuncs.com"
// 镜像仓库命名空间名称
def DOCKER_REGISTRY_NAMESPACE = "zhengqingya"
// 镜像拉取凭证 =&gt; jenkins全局凭证中配置
def DOCKER_REGISTRY_AUTH = "aliyun_docker_registry_auth"


// ==================== ↓↓↓↓↓↓ git ↓↓↓↓↓↓ ====================
// git凭证 =&gt; jenkins全局凭证中配置
def GIT_AUTH = "gitee_auth"


// ==================== ↓↓↓↓↓↓ project ↓↓↓↓↓↓ ====================
// 项目-git地址
def PROJECT_GIT_URL = "https://gitee.com/zhengqingya/small-tools.git"
// 项目-公共模块名称
def PROJECT_SERVICE_COMMON_NAME = "small-tools-api/common"
def PROJECT_SERVICE_API_NAME = "small-tools-api/service-api"
// 项目-基础目录
def PROJECT_BASE_HOME = "/Users/zhengqingya/IT_zhengqing/soft/small-tools"
// 项目-服务日志目录
def PROJECT_SERVICE_LOG_HOME = "${PROJECT_BASE_HOME}/logs"
// 项目-jar文件目录
def PROJECT_JAR_HOME = "${PROJECT_BASE_HOME}/target"
// 项目-docker部署的历史jar目录
def PROJECT_DOCKER_HISTORY_JAR_HOME = "${PROJECT_BASE_HOME}/docker-history-jar"


node {
    // jenkins工作空间
    def JENKINS_WORKSPACE = "${WORKSPACE}"
    // 取哪一块网卡值
    def ETH_VALUE = ""
    // 当前时间
    def CURRENT_TIME = ""
    // 获取选择的项目服务名称
    def project_service_name_select = "${PROJECT_SERVICE_NAME}".split(",")
    // 获取选择的服务器名称
    def publish_ssh_server_select = "${PUBLISH_SSH_SERVER}".split(",")
    // app镜像tag
    def app_docker_image_tag = ""


    stage('初始化准备') {
        echo '****************************** 初始化准备 ******************************'
        // 网卡值设置 [注:正常liunx取eth0的内网ip，局域网取enp5s0的内网ip]
        ETH_VALUE = sh(script: "( [[ \"${JAVA_OPTS}\" = *'-Dspring.cloud.nacos.discovery.ip'* ]] &amp;&amp; echo enp5s0 || echo eth0 )", returnStdout: true).trim()
        CURRENT_TIME = sh(script: "echo `date +\"%Y-%m-%d %H:%M:%S\"`", returnStdout: true).trim()
        script {
            app_docker_image_tag = GIT_BRANCH.replaceAll('origin/', '')
        }
        echo "当前工作空间：${JENKINS_WORKSPACE}"
        echo "使用分支：${GIT_BRANCH}"
        echo "使用docker镜像tag：${app_docker_image_tag}"
        echo "使用网卡：${ETH_VALUE}"
        echo "当前时间：${CURRENT_TIME}"
        sh "mkdir -p ${PROJECT_SERVICE_LOG_HOME}"
        sh "mkdir -p ${PROJECT_JAR_HOME}"
        sh "mkdir -p ${PROJECT_DOCKER_HISTORY_JAR_HOME}"
    }


    stage('拉取代码') {
        echo '****************************** 拉取代码 ******************************'
        checkout([$class: 'GitSCM', branches: [[name: "${GIT_BRANCH}"]], extensions: [], userRemoteConfigs: [[credentialsId: "${GIT_AUTH}", url: "${PROJECT_GIT_URL}"]]])
        sh "pwd"
    }


    stage('公共工程打包') {
        echo '****************************** 公共工程打包 ******************************'
        sh "mvn -f ${PROJECT_SERVICE_COMMON_NAME} clean install -Dmaven.test.skip=true"
        sh "mvn -f ${PROJECT_SERVICE_API_NAME} clean install -Dmaven.test.skip=true"
    }

    stage('微服务打包&amp;删除旧容器和镜像&amp;推送镜像&amp;部署远程服务器') {
        echo '****************************** 微服务打包&amp;删除旧容器和镜像&amp;推送镜像&amp;部署远程服务器 ******************************'

        for (int i = 0; i &lt; project_service_name_select.length; i++) {

            // 当前待处理项目
            def current_app_name = project_service_name_select[i];
            def current_app_jar = "${current_app_name}.jar";
            // 父工程
            def current_app_parent = ""
            // 端口号
            def current_app_port = ""

            echo "当前操作项目: ${current_app_name}"

            script {
                switch (current_app_name) {
                    case "demo":
                        current_app_parent = "small-tools-api/service"
                        current_app_port = "20040"
                        break
                    case "system":
                        current_app_parent = "small-tools-api/service"
                        current_app_port = "20010"
                        break
                    case "tool":
                        current_app_parent = "small-tools-api/service"
                        current_app_port = "20030"
                        break
                    case "gateway":
                        current_app_port = "1218"
                        current_app_parent = "small-tools-api"
                        break
                }
            }

            echo "当前操作项目： ${current_app_name} 端口：${current_app_port}"

            sh "mvn -f ${current_app_parent}/${current_app_name} clean install -Dmaven.test.skip=true"

            sh "cp ${current_app_parent}/${current_app_name}/target/${current_app_jar} ${JENKINS_WORKSPACE}/small-tools-api/docker"

            // app镜像
            def app_docker_image = "${DOCKER_REGISTRY_URL}/${DOCKER_REGISTRY_NAMESPACE}/${current_app_name}:${app_docker_image_tag}"

            echo "app镜像: ${app_docker_image}"

            // 删除旧容器
            sh "docker ps -a | grep ${current_app_name} | grep ${app_docker_image_tag} | awk '{print \$1}' | xargs -I docker stop {} | xargs -I docker rm {}"
            // 删除旧镜像
            sh "docker images | grep -E ${current_app_name} | grep ${app_docker_image_tag}| awk '{print \$3}' | uniq | xargs -I {} docker rmi --force {}"
            // 构建新镜像 -f:指定Dockerfile文件路径
            sh "cd ${JENKINS_WORKSPACE}/small-tools-api/docker &amp;&amp; docker build -f Dockerfile --build-arg JAVA_OPTS=\"${JAVA_OPTS}\" --build-arg APP_NAME=${current_app_name} --build-arg APP_PORT=${current_app_port} -t ${app_docker_image} . --no-cache"


            echo '-------------------- 项目部署 --------------------'

            withCredentials([usernamePassword(credentialsId: "${DOCKER_REGISTRY_AUTH}", passwordVariable: 'password', usernameVariable: 'username')]) {
                //登录到腾讯云镜像仓库
                sh "docker login -u ${username} -p ${password} ${DOCKER_REGISTRY_URL}"
                //镜像上传
                sh "docker push ${app_docker_image}"

                sh "echo 镜像上传成功：${app_docker_image}"
            }

            //构建完镜像后移除docker 目录下的jar文件，防止docker将多个jar一起构建
            sh "mv -f ${JENKINS_WORKSPACE}/small-tools-api/docker/*.jar ${PROJECT_DOCKER_HISTORY_JAR_HOME}/"

            //遍历所有服务器，分别部署
            for (int j = 0; j &lt; publish_ssh_server_select.length; j++) {
                //获取当前遍历的服务器名称
                def currentServerName = publish_ssh_server_select[j]
                echo '开始发布远程机器'
                sshPublisher(publishers: [sshPublisherDesc(configName: "${currentServerName}",
                        transfers: [sshTransfer(cleanRemote: false, excludes: '',
                                execCommand: """
                                    // 删除旧容器
                                    docker ps -a | grep ${current_app_name} | grep ${app_docker_image_tag} | awk '{print \$1}' | xargs -i docker stop {} | xargs -i docker rm {}
                                    // 删除旧镜像
                                    docker images | grep -E ${current_app_name} | grep ${app_docker_image_tag}| awk '{print \$3}' | uniq | xargs -I {} docker rmi --force {}
                                    // 拉取新镜像
                                    docker pull ${app_docker_image}
                                    // 创建日志文件
                                    mkdir -p ${PROJECT_SERVICE_LOG_HOME}
                                    cd ${PROJECT_SERVICE_LOG_HOME}
                                    touch ${current_app_name}.log
                                    // 运行容器
                                    echo "*** ${CURRENT_TIME} docker run -d -p ${current_app_port}:${current_app_port} -e JAVA_OPTS="${JAVA_OPTS} -Dspring.cloud.nacos.discovery.ip=`ifconfig ${ETH_VALUE} | grep inet | grep -v inet6 | awk '{print \$2}'`" -v ${PROJECT_SERVICE_LOG_HOME}/${current_app_name}.log:/home/${current_app_name}.log --name ${current_app_name}  ${app_docker_image}" &gt;&gt; ${PROJECT_SERVICE_LOG_HOME}/run.log
                                    docker run -d -p ${current_app_port}:${current_app_port} -e JAVA_OPTS="${JAVA_OPTS} -Dspring.cloud.nacos.discovery.ip=`ifconfig ${ETH_VALUE} | grep inet | grep -v inet6 | awk '{print \$2}'`" -v ${PROJECT_SERVICE_LOG_HOME}/${current_app_name}.log:/home/${current_app_name}.log --name ${current_app_name}  ${app_docker_image}
                                """,
                                execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false,
                                patternSeparator: '[, ]+', remoteDirectory: '', remoteDirectorySDF: false, removePrefix: '',
                                sourceFiles: '')], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])
            }

        }

    }

}
</code></pre>
<h3><a id="jenkins_292"></a>五、jenkins新建任务</h3>
<p><img src="https://img-blog.csdnimg.cn/360cd3b6ee734fa7bfbe30f30cea0ba2.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
参数化配置<br>
<code>GIT_BRANCH</code><br>
<img src="https://img-blog.csdnimg.cn/7e1ef6cb47f3489d9fcde5b8a78b9950.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
<code>PROJECT_SERVICE_NAME</code><br>
<img src="https://img-blog.csdnimg.cn/8f0d1a463f0749d78f670fd209d5f699.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
<code>PUBLISH_SSH_SERVER</code></p>
<blockquote>
<p>注：value值为之前在<code>Manage Jenkins</code> -&gt; <code>Configure System</code>中配置的<code>SSH Server</code> Name值<br>
<img src="https://img-blog.csdnimg.cn/f6e1333bb7364c32b65bc87b5cc71895.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/e0a1acb4b4fb4a4bb2c603e086934f42.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
<code>JAVA_OPTS</code><br>
<img src="https://img-blog.csdnimg.cn/605e6773e05c411384a8275011c28170.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
流水线<br>
<img src="https://img-blog.csdnimg.cn/221a3f44322b48c8a957a0191a9677eb.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>
配置完成后应用保存</p>
<h3><a id="_313"></a>六、构建测试</h3>
<blockquote>
<p>温馨小提示：第1次构建的时候会出现如下情况，是因为未拉取远程git仓库获取分支信息，第2次就好了…<br>
<img src="https://img-blog.csdnimg.cn/4ae027257c734f69b41d9cbb2b99a6c9.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/b4c409b1f2184dd9a720441dbed19c88.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>构建成功如下<br>
<img src="https://img-blog.csdnimg.cn/363ea5f00f974b618127840cc3144bb5.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA6YOR5riF,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>一个简单的部署方案完成 <code>^_^</code></p>
<h3><a id="_326"></a>七、其它</h3>
<pre><code class="prism language-shell"><span class="token comment"># 打包镜像 -f:指定Dockerfile文件路径</span>
docker build -f Dockerfile --build-arg <span class="token assign-left variable">JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-XX:+UseG1GC -Xms64m -Xmx64m -Xmn16m -XX:MetaspaceSize=100m -XX:MaxMetaspaceSize=100m -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 -Ddefault.client.encoding=UTF-8 -Dfile.encoding=UTF-8 -Duser.language=Zh -Duser.region=CN"</span> --build-arg <span class="token assign-left variable">APP_NAME</span><span class="token operator">=</span><span class="token string">"demo"</span> --build-arg <span class="token assign-left variable">APP_PORT</span><span class="token operator">=</span><span class="token string">"80"</span> -t <span class="token string">"registry.cn-hangzhou.aliyuncs.com/zhengqingya/demo:dev"</span> <span class="token builtin class-name">.</span> --no-cache

<span class="token comment"># 推送镜像</span>
docker push registry.cn-hangzhou.aliyuncs.com/zhengqingya/demo:dev

<span class="token comment"># 拉取镜像</span>
docker pull registry.cn-hangzhou.aliyuncs.com/zhengqingya/demo:dev

<span class="token comment"># 运行</span>
docker run -d -p <span class="token number">80</span>:80 -v /home/zhengqingya/demo.log:/home/demo.log --name demo registry.cn-hangzhou.aliyuncs.com/zhengqingya/demo:dev

<span class="token comment"># 删除旧容器</span>
<span class="token comment">#docker ps -a | grep demo | grep dev | awk '{print $1}' | xargs -i docker stop {} | xargs -i docker rm {}</span>
docker <span class="token function">ps</span> -a <span class="token operator">|</span> <span class="token function">grep</span> demo <span class="token operator">|</span> <span class="token function">grep</span> dev <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I docker stop <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I docker <span class="token function">rm</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># 删除旧镜像</span>
docker images <span class="token operator">|</span> <span class="token function">grep</span> -E demo <span class="token operator">|</span> <span class="token function">grep</span> dev <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$3</span>}'</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token operator">|</span> <span class="token function">xargs</span> -I <span class="token punctuation">{</span><span class="token punctuation">}</span> docker rmi --force <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre>
<hr>
<blockquote>
<p>今日分享语句：<br>
总有一天，你会明白：你的委屈要自己消化，你的故事不用逢人就讲起；真正理解你的没有几个，大多人只会站在他们自己的立场，偷看你的笑话；你能做的就是把秘密藏起来，然后一步一步变得越来越强大！</p>
</blockquote>
</div>
</body>

</html>
